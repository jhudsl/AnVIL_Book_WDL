<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 5 Customize Docker | WDL Workflows</title>
  <meta name="description" content="Description about Course/Book." />
  <meta name="generator" content="bookdown 0.24 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 5 Customize Docker | WDL Workflows" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="Description about Course/Book." />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 5 Customize Docker | WDL Workflows" />
  
  <meta name="twitter:description" content="Description about Course/Book." />
  



<meta name="date" content="2023-11-15" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  <link rel="shortcut icon" href="assets/AnVIL_style/anvil_favicon.ico" type="image/x-icon" />
<link rel="prev" href="calculate-idxstats-on-multiple-files.html"/>
<link rel="next" href="join-discourse.html"/>
<script src="libs/header-attrs-2.10/header-attrs.js"></script>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.0.1/anchor-sections.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.0.1/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  background-color: #f8f8f8; }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ef2929; } /* Alert */
code span.an { color: #8f5902; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #c4a000; } /* Attribute */
code span.bn { color: #0000cf; } /* BaseN */
code span.cf { color: #204a87; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4e9a06; } /* Char */
code span.cn { color: #000000; } /* Constant */
code span.co { color: #8f5902; font-style: italic; } /* Comment */
code span.cv { color: #8f5902; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #8f5902; font-weight: bold; font-style: italic; } /* Documentation */
code span.dt { color: #204a87; } /* DataType */
code span.dv { color: #0000cf; } /* DecVal */
code span.er { color: #a40000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #0000cf; } /* Float */
code span.fu { color: #000000; } /* Function */
code span.im { } /* Import */
code span.in { color: #8f5902; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #204a87; font-weight: bold; } /* Keyword */
code span.op { color: #ce5c00; font-weight: bold; } /* Operator */
code span.ot { color: #8f5902; } /* Other */
code span.pp { color: #8f5902; font-style: italic; } /* Preprocessor */
code span.sc { color: #000000; } /* SpecialChar */
code span.ss { color: #4e9a06; } /* SpecialString */
code span.st { color: #4e9a06; } /* String */
code span.va { color: #000000; } /* Variable */
code span.vs { color: #4e9a06; } /* VerbatimString */
code span.wa { color: #8f5902; font-weight: bold; font-style: italic; } /* Warning */
</style>


<link rel="stylesheet" href="assets/style.css" type="text/css" />
<link rel="stylesheet" href="assets/AnVIL_style/anvil.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<a href="https://anvilproject.org/" target="_blank"><img src="assets/AnVIL_style/logo-anvil.png" style="width: 80%; padding-left: 15px; padding-top: 8px;"</a>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Overview</a>
<ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#skills-level"><i class="fa fa-check"></i>Skills Level</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#learning-objectives"><i class="fa fa-check"></i>Learning Objectives</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#timing"><i class="fa fa-check"></i>Timing</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#branding"><i class="fa fa-check"></i>Branding</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#anvil-collection"><i class="fa fa-check"></i>AnVIL Collection</a></li>
</ul></li>
<li class="chapter" data-level="1" data-path="review-workflows-on-anvil-powered-by-terra.html"><a href="review-workflows-on-anvil-powered-by-terra.html"><i class="fa fa-check"></i><b>1</b> Review Workflows on AnVIL-powered-by-Terra</a>
<ul>
<li class="chapter" data-level="1.1" data-path="review-workflows-on-anvil-powered-by-terra.html"><a href="review-workflows-on-anvil-powered-by-terra.html#optional-what-is-a-workflow"><i class="fa fa-check"></i><b>1.1</b> Optional: What is a workflow?</a></li>
<li class="chapter" data-level="1.2" data-path="review-workflows-on-anvil-powered-by-terra.html"><a href="review-workflows-on-anvil-powered-by-terra.html#optional-running-a-workflow-on-anvil-powered-by-terra"><i class="fa fa-check"></i><b>1.2</b> Optional: Running a workflow on AnVIL-powered-by-Terra</a>
<ul>
<li class="chapter" data-level="1.2.1" data-path="review-workflows-on-anvil-powered-by-terra.html"><a href="review-workflows-on-anvil-powered-by-terra.html#clone-workspace"><i class="fa fa-check"></i><b>1.2.1</b> Clone Workspace</a></li>
<li class="chapter" data-level="1.2.2" data-path="review-workflows-on-anvil-powered-by-terra.html"><a href="review-workflows-on-anvil-powered-by-terra.html#view-wdl"><i class="fa fa-check"></i><b>1.2.2</b> View WDL</a></li>
<li class="chapter" data-level="1.2.3" data-path="review-workflows-on-anvil-powered-by-terra.html"><a href="review-workflows-on-anvil-powered-by-terra.html#configure-workflow"><i class="fa fa-check"></i><b>1.2.3</b> Configure Workflow</a></li>
<li class="chapter" data-level="1.2.4" data-path="review-workflows-on-anvil-powered-by-terra.html"><a href="review-workflows-on-anvil-powered-by-terra.html#examine-output"><i class="fa fa-check"></i><b>1.2.4</b> Examine Output</a></li>
<li class="chapter" data-level="1.2.5" data-path="review-workflows-on-anvil-powered-by-terra.html"><a href="review-workflows-on-anvil-powered-by-terra.html#watch-video"><i class="fa fa-check"></i><b>1.2.5</b> Watch Video</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="2" data-path="import-and-configure-workflows.html"><a href="import-and-configure-workflows.html"><i class="fa fa-check"></i><b>2</b> Import and Configure Workflows</a>
<ul>
<li class="chapter" data-level="2.1" data-path="import-and-configure-workflows.html"><a href="import-and-configure-workflows.html#importing-workflows-into-anvil-powered-by-terra"><i class="fa fa-check"></i><b>2.1</b> Importing workflows into AnVIL-powered-by-Terra</a>
<ul>
<li class="chapter" data-level="2.1.1" data-path="import-and-configure-workflows.html"><a href="import-and-configure-workflows.html#dockstore"><i class="fa fa-check"></i><b>2.1.1</b> Dockstore</a></li>
<li class="chapter" data-level="2.1.2" data-path="import-and-configure-workflows.html"><a href="import-and-configure-workflows.html#broad-methods-repository"><i class="fa fa-check"></i><b>2.1.2</b> Broad Methods Repository</a></li>
<li class="chapter" data-level="2.1.3" data-path="import-and-configure-workflows.html"><a href="import-and-configure-workflows.html#other-online-collections"><i class="fa fa-check"></i><b>2.1.3</b> Other online collections</a></li>
</ul></li>
<li class="chapter" data-level="2.2" data-path="import-and-configure-workflows.html"><a href="import-and-configure-workflows.html#configuring-workflows-with-json-files"><i class="fa fa-check"></i><b>2.2</b> Configuring workflows with JSON files</a>
<ul>
<li class="chapter" data-level="2.2.1" data-path="import-and-configure-workflows.html"><a href="import-and-configure-workflows.html#optional-practice-pre-configure-a-workflow"><i class="fa fa-check"></i><b>2.2.1</b> Optional practice: pre-configure a workflow</a></li>
<li class="chapter" data-level="2.2.2" data-path="import-and-configure-workflows.html"><a href="import-and-configure-workflows.html#a-few-notes-on-syntax"><i class="fa fa-check"></i><b>2.2.2</b> A few notes on syntax</a></li>
<li class="chapter" data-level="2.2.3" data-path="import-and-configure-workflows.html"><a href="import-and-configure-workflows.html#importing-a-pre-configured-workflow"><i class="fa fa-check"></i><b>2.2.3</b> Importing a pre-configured workflow</a></li>
<li class="chapter" data-level="2.2.4" data-path="import-and-configure-workflows.html"><a href="import-and-configure-workflows.html#more-information"><i class="fa fa-check"></i><b>2.2.4</b> More information</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="import-and-configure-workflows.html"><a href="import-and-configure-workflows.html#further-reading"><i class="fa fa-check"></i><b>2.3</b> Further Reading</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="write-wdl.html"><a href="write-wdl.html"><i class="fa fa-check"></i><b>3</b> Write WDL</a>
<ul>
<li class="chapter" data-level="3.1" data-path="write-wdl.html"><a href="write-wdl.html#access-broad-methods-repository"><i class="fa fa-check"></i><b>3.1</b> Access Broad Methods Repository</a></li>
<li class="chapter" data-level="3.2" data-path="write-wdl.html"><a href="write-wdl.html#wdl-script-structure"><i class="fa fa-check"></i><b>3.2</b> WDL Script Structure</a></li>
<li class="chapter" data-level="3.3" data-path="write-wdl.html"><a href="write-wdl.html#write-a-hello-input-wdl"><i class="fa fa-check"></i><b>3.3</b> Write a hello-input WDL</a></li>
<li class="chapter" data-level="3.4" data-path="write-wdl.html"><a href="write-wdl.html#export-to-anvil-powered-by-terra-and-run"><i class="fa fa-check"></i><b>3.4</b> Export to AnVIL-powered-by-Terra and run</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="calculate-idxstats-on-multiple-files.html"><a href="calculate-idxstats-on-multiple-files.html"><i class="fa fa-check"></i><b>4</b> Calculate idxstats on multiple files</a>
<ul>
<li class="chapter" data-level="4.1" data-path="calculate-idxstats-on-multiple-files.html"><a href="calculate-idxstats-on-multiple-files.html#clone-data-workspace"><i class="fa fa-check"></i><b>4.1</b> Clone data workspace</a></li>
<li class="chapter" data-level="4.2" data-path="calculate-idxstats-on-multiple-files.html"><a href="calculate-idxstats-on-multiple-files.html#write-an-idxstats-wdl"><i class="fa fa-check"></i><b>4.2</b> Write an idxstats WDL</a></li>
<li class="chapter" data-level="4.3" data-path="calculate-idxstats-on-multiple-files.html"><a href="calculate-idxstats-on-multiple-files.html#optional-run-idxstats-wdl-on-multiple-.bam-files"><i class="fa fa-check"></i><b>4.3</b> Optional: Run idxstats WDL on multiple .bam files</a></li>
<li class="chapter" data-level="4.4" data-path="calculate-idxstats-on-multiple-files.html"><a href="calculate-idxstats-on-multiple-files.html#customize-your-workflows-setup-with-wdl"><i class="fa fa-check"></i><b>4.4</b> Customize your Workflow’s Setup with WDL</a>
<ul>
<li class="chapter" data-level="4.4.1" data-path="calculate-idxstats-on-multiple-files.html"><a href="calculate-idxstats-on-multiple-files.html#memory-retry"><i class="fa fa-check"></i><b>4.4.1</b> Memory retry</a></li>
<li class="chapter" data-level="4.4.2" data-path="calculate-idxstats-on-multiple-files.html"><a href="calculate-idxstats-on-multiple-files.html#localizing-files"><i class="fa fa-check"></i><b>4.4.2</b> Localizing files</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="customize-docker.html"><a href="customize-docker.html"><i class="fa fa-check"></i><b>5</b> Customize Docker</a>
<ul>
<li class="chapter" data-level="5.1" data-path="customize-docker.html"><a href="customize-docker.html#prerequisites"><i class="fa fa-check"></i><b>5.1</b> Prerequisites</a></li>
<li class="chapter" data-level="5.2" data-path="customize-docker.html"><a href="customize-docker.html#containerization-with-docker"><i class="fa fa-check"></i><b>5.2</b> Containerization with Docker</a>
<ul>
<li class="chapter" data-level="5.2.1" data-path="customize-docker.html"><a href="customize-docker.html#why-is-containerization-helpful"><i class="fa fa-check"></i><b>5.2.1</b> Why is containerization helpful?</a></li>
<li class="chapter" data-level="5.2.2" data-path="customize-docker.html"><a href="customize-docker.html#docker-containers"><i class="fa fa-check"></i><b>5.2.2</b> Docker containers</a></li>
<li class="chapter" data-level="5.2.3" data-path="customize-docker.html"><a href="customize-docker.html#using-docker-containers-in-your-workflow"><i class="fa fa-check"></i><b>5.2.3</b> Using Docker containers in your workflow</a></li>
</ul></li>
<li class="chapter" data-level="5.3" data-path="customize-docker.html"><a href="customize-docker.html#using-a-published-docker-image-out-of-the-box"><i class="fa fa-check"></i><b>5.3</b> Using a Published Docker Image Out of the Box</a>
<ul>
<li class="chapter" data-level="5.3.1" data-path="customize-docker.html"><a href="customize-docker.html#google"><i class="fa fa-check"></i><b>5.3.1</b> Google</a></li>
<li class="chapter" data-level="5.3.2" data-path="customize-docker.html"><a href="customize-docker.html#docker-hub-and-quay.io"><i class="fa fa-check"></i><b>5.3.2</b> Docker Hub and Quay.io</a></li>
<li class="chapter" data-level="5.3.3" data-path="customize-docker.html"><a href="customize-docker.html#dockerbio"><i class="fa fa-check"></i><b>5.3.3</b> DockerBIO</a></li>
<li class="chapter" data-level="5.3.4" data-path="customize-docker.html"><a href="customize-docker.html#next-steps"><i class="fa fa-check"></i><b>5.3.4</b> Next steps</a></li>
</ul></li>
<li class="chapter" data-level="5.4" data-path="customize-docker.html"><a href="customize-docker.html#configure-github-actions"><i class="fa fa-check"></i><b>5.4</b> Configure GitHub Actions</a></li>
<li class="chapter" data-level="5.5" data-path="customize-docker.html"><a href="customize-docker.html#build-docker-image"><i class="fa fa-check"></i><b>5.5</b> Build Docker image</a></li>
<li class="chapter" data-level="5.6" data-path="customize-docker.html"><a href="customize-docker.html#use-your-image-with-the-idxstats-wdl"><i class="fa fa-check"></i><b>5.6</b> Use your image with the idxstats WDL</a></li>
<li class="chapter" data-level="5.7" data-path="customize-docker.html"><a href="customize-docker.html#run-idxstats-workflow"><i class="fa fa-check"></i><b>5.7</b> Run idxstats workflow</a></li>
<li class="chapter" data-level="5.8" data-path="customize-docker.html"><a href="customize-docker.html#best-practices-for-using-docker"><i class="fa fa-check"></i><b>5.8</b> Best practices for using Docker</a></li>
<li class="chapter" data-level="5.9" data-path="customize-docker.html"><a href="customize-docker.html#further-reading-1"><i class="fa fa-check"></i><b>5.9</b> Further Reading</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="join-discourse.html"><a href="join-discourse.html"><i class="fa fa-check"></i><b>6</b> Join Discourse</a></li>
<li class="chapter" data-level="" data-path="about-the-authors.html"><a href="about-the-authors.html"><i class="fa fa-check"></i>About the Authors</a></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<p style="text-align:center;"> <a href="https://github.com/jhudsl/OTTR_Template" target="blank" > This content was published with</a> <a href="https://bookdown.org/" target="blank"> bookdown by: </a> </p>
<p style="text-align:center;"> <a href="https://hutchdatascience.org/"> The Fred Hutch Data Science Lab </a></p>
<a href="https://hutchdatascience.org/" target="_blank"><img src="https://raw.githubusercontent.com/jhudsl/OTTR_Template/main/style-sets/fhdasl/copy_to_assets/big-dasl-stacked.png" style="width: 80%; padding-left: 34px; padding-top: 8px;"</a>
<p style="text-align:center; font-size: 12px;"> <a href="https://github.com/rstudio4edu/rstudio4edu-book/"> Style adapted from: rstudio4edu-book </a> <a href ="https://creativecommons.org/licenses/by/2.0/"> (CC-BY 2.0) </a></p>
<p style="padding-left: 40px;"><div class="trapezoid" style = "padding-left: 40px;"><span>  <a href="https://forms.gle/AK12iVXTjsB7yCUUA"> Click here to provide feedback</a> <img src="assets/itcr_arrow.png" style=" width: 10%" ></span></div></p>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">WDL Workflows</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<head>
  <meta name="viewport" content="width=device-width,minimum-scale=1.0,maximum-scale=10.0,initial-scale=1.0">
  <!--script src="https://kit.fontawesome.com/6a26f47516.js"></script-->
  <!--<script src="assets/hideOutput.js"></script>-->
</head>
        


<div class="hero-image-container"> 
  <img class= "hero-image" src="assets/AnVIL_style/dasl_thin_main_image.png">
</div>
<div id="customize-docker" class="section level1" number="5">
<h1><span class="header-section-number">Chapter 5</span> Customize Docker</h1>
<p>Having run a workflow, written a WDL, and localized a file, let’s now build a custom Docker image.
This tutorial demonstrates how to build a Docker image that contains <a href="https://pubmed.gov/19505943">SAMtools</a> so that we can calculate <a href="http://www.htslib.org/doc/samtools-idxstats.html">idxstats</a> on a small .bam file.
We will use the GitHub Action <a href="https://github.com/marketplace/actions/build-and-push-docker-images">build-and-push-docker-images</a> so that you do not need to have Docker installed locally.
This material was modified from the <a href="https://support.terra.bio/hc/en-us/articles/18618717942427">WDL Bootcamp Workshop</a>.
More information about making Docker images can be found in <a href="https://support.terra.bio/hc/en-us/articles/360024737591">this Terra Support article</a>.</p>
<p><strong>Learning Objectives</strong></p>
<ol style="list-style-type: decimal">
<li>Identify what containerization is, and why it’s helpful for running workflows</li>
<li>Identify the key components of a Docker container</li>
<li>Understand how to find and use a pre-existing Docker image</li>
<li>Configure GitHub Actions</li>
<li>Build and run a Docker image</li>
<li>Create idxstats WDL</li>
<li>Run idxstats workflow</li>
<li>Understand how to specify a container for an AnVIL-powered-by-Terra workflow</li>
</ol>
<div id="prerequisites" class="section level2" number="5.1">
<h2><span class="header-section-number">5.1</span> Prerequisites</h2>
<div class="notice">
<p><strong>GitHub</strong>: <a href="https://github.com/signup">Create an account</a> to build Docker images using GitHub Actions</p>
<p><strong>Docker Hub</strong>: <a href="https://hub.docker.com/signup">Create an account</a> to publish Docker images that AnVIL can access</p>
</div>
</div>
<div id="containerization-with-docker" class="section level2" number="5.2">
<h2><span class="header-section-number">5.2</span> Containerization with Docker</h2>
<p>Behind the scenes, a workflow requires four main elements:</p>
<ol style="list-style-type: decimal">
<li><strong>Data</strong></li>
<li>A <strong>workflow script</strong> (written in WDL)</li>
<li>An <strong>execution engine</strong> to manage the workflow’s jobs</li>
<li>A <strong>container</strong> in which to run the workflow</li>
</ol>
<p><img src="05-customize-docker_files/figure-html/1o2XnuMbqWVLf4XrsXolIQ7ulfnMlpJlrUxN0Y8aLIVQ_g278ce060607_0_0.png" width="100%" /></p>
<p>These elements all work together to run the workflow – the container’s role is to control all of the code packages and dependencies used to run the workflow’s WDL script. This is called “<strong>containerization</strong>.”</p>
<div id="why-is-containerization-helpful" class="section level3" number="5.2.1">
<h3><span class="header-section-number">5.2.1</span> Why is containerization helpful?</h3>
<p>Containerization makes it easier to reproduce workflow analyses. For example, if two collaborators are analyzing the same data using different versions of Python, they might get different results. Containerization controls the environments in which you’re running these analyses, saving you from puzzling over incompatible results. Containerization can also ensure that other researchers can replicate your results and apply your tools to their own data. Containerization is even helpful when re-running old code – if your code packages have automatically updated since you last ran the code, using a container may prevent your code from breaking.</p>
</div>
<div id="docker-containers" class="section level3" number="5.2.2">
<h3><span class="header-section-number">5.2.2</span> Docker containers</h3>
<p>You can manage your containers with several services. We’ll focus on <strong>Docker</strong>.</p>
<p>Docker containers have two main components:</p>
<ol style="list-style-type: decimal">
<li>A <strong>Docker file</strong> that defines the container’s dependencies, environment variables, file system, and applications.</li>
<li>A <strong>Docker image</strong> that builds and runs a container, which contains everything defined in the Docker file.</li>
</ol>
<p>In addition, a <strong>registry</strong> (e.g., DockerHub) is used to share Docker images with others, and to make your Docker image accessible from the Cloud (e.g., in AnVIL-powered-by-Terra).</p>
<p><img src="05-customize-docker_files/figure-html/1o2XnuMbqWVLf4XrsXolIQ7ulfnMlpJlrUxN0Y8aLIVQ_g278ce060607_0_8.png" width="100%" /></p>
</div>
<div id="using-docker-containers-in-your-workflow" class="section level3" number="5.2.3">
<h3><span class="header-section-number">5.2.3</span> Using Docker containers in your workflow</h3>
<p>A workflow’s container constrains the code that you can write in the WDL script; for example, a WDL script with Python commands must be run in a container that includes Python. So, how can you ensure that you’re using the right container on AnVIL-powered-by-Terra?</p>
<p>To direct AnVIL-powered-by-Terra toward the correct container, specify the container’s image in the WDL script. We already did this in the exercise from Chapter 3, by including a “docker” variable in the “runtime” section of the task definition:</p>
<pre><code>  runtime {
   docker: &#39;ubuntu:latest&#39;
  }</code></pre>
<p>In this example, we simply specified the most up-to-date Ubuntu image. However, in many cases the best choice is to use a specific image, which won’t change after you’ve written the workflow.</p>
<p>Note that you can use different images in different tasks within your workflow.</p>
</div>
</div>
<div id="using-a-published-docker-image-out-of-the-box" class="section level2" number="5.3">
<h2><span class="header-section-number">5.3</span> Using a Published Docker Image Out of the Box</h2>
<p>To set up your workflow’s container, you can build a Docker image from scratch, modify an existing image, or find a published image that you can use out of the box, without any modifications.</p>
<p>This last option is a particularly good option when you only need your container to include a single tool. You can find useful images in the following ways:</p>
<div id="google" class="section level3" number="5.3.1">
<h3><span class="header-section-number">5.3.1</span> Google</h3>
<p>A good first step is to search for “Docker image” and the name of the software that you want to include in the container on a search engine like Google or Bing.</p>
</div>
<div id="docker-hub-and-quay.io" class="section level3" number="5.3.2">
<h3><span class="header-section-number">5.3.2</span> Docker Hub and Quay.io</h3>
<p><a href="https://hub.docker.com">Docker Hub</a> is an online platform for sharing Docker images. Use the “Explore” menu to filter for suitable images. It’s a good idea to filter for images from trusted sources, including Docker official images and images from verified publishers.</p>
<p><a href="https://quay.io">Quay.io</a> is another Docker-sharing platform, with similar functionality.</p>
</div>
<div id="dockerbio" class="section level3" number="5.3.3">
<h3><span class="header-section-number">5.3.3</span> DockerBIO</h3>
<p><a href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC6266945">DockerBIO</a> is a Java web application that focuses on Docker images for bioinformatics analyses. This approach requires a bit more setup, but can make it easier to find an image that’s relevant to your work.</p>
</div>
<div id="next-steps" class="section level3" number="5.3.4">
<h3><span class="header-section-number">5.3.4</span> Next steps</h3>
<p>Once you’ve found a published image that suits your needs, clone it to create your own copy. This will ensure that your analysis is reproducible, because the image won’t change unless you edit it.</p>
<p>Sections 5.4 and 5.5 show you how to take a step further, and modify a published image for your workflow. To see how to use a Docker image without any modification, skip these sections and start again at section 5.6.</p>
</div>
</div>
<div id="configure-github-actions" class="section level2" number="5.4">
<h2><span class="header-section-number">5.4</span> Configure GitHub Actions</h2>
<p>In the next section, we’ll get more in the weeds to show you how to modify a published Docker image to customize it for your workflow.</p>
<p>The GitHub Action <a href="https://github.com/marketplace/actions/build-and-push-docker-images">build-and-push-docker-images</a> provides a Cloud-based solution to building a Docker image and pushing it to <a href="https://hub.docker.com">Docker Hub</a>.
We will start with a repository created for the ITN course <a href="https://jhudatascience.org/Reproducibility_in_Cancer_Informatics">Intro to Reproducibility in Cancer Informatics</a> that has this GitHub Action configured.</p>
<p>First, fork the <a href="https://github.com/jhudsl/reproducible-R-example">reproducible-R-example</a> repository.</p>
<p><img src="05-customize-docker_files/figure-html/1o2XnuMbqWVLf4XrsXolIQ7ulfnMlpJlrUxN0Y8aLIVQ_g1397c25e58c_0_177.png" width="100%" /></p>
<p>Your new repository must be configured with the proper credentials (referred to as <a href="https://docs.github.com/en/actions/security-guides/encrypted-secrets">Actions secrets</a> by GitHub) to push an image to Docker Hub. Follow the <a href="https://www.ottrproject.org/customize-docker.html#Set_Dockerhub_related_secrets">OTTR Project instructions</a>) to set <code>DOCKERHUB_USERNAME</code> and <code>DOCKERHUB_TOKEN</code>.</p>
<p><img src="05-customize-docker_files/figure-html/1o2XnuMbqWVLf4XrsXolIQ7ulfnMlpJlrUxN0Y8aLIVQ_g158d610a26d_0_3.png" width="100%" /></p>
<p>Update the <code>.github/workflows/docker-management.yml</code> file with your Docker Hub username and repository. For example, change <code>jhudsl/reproducible-r</code> to <code>my_username/my_repository</code>. Note that you need to change this on both line 53 and line 71.</p>
<p><img src="05-customize-docker_files/figure-html/1o2XnuMbqWVLf4XrsXolIQ7ulfnMlpJlrUxN0Y8aLIVQ_g158d610a26d_0_8.png" width="100%" /></p>
<p>This <code>docker-management.yml</code> file points Docker toward the correct Docker image file and links your GitHub repository with your Docker account.</p>
</div>
<div id="build-docker-image" class="section level2" number="5.5">
<h2><span class="header-section-number">5.5</span> Build Docker image</h2>
<p>The <code>docker/Dockerfile</code> file is the Docker image file, which is written in YAML syntax. It typically initializes the container with a base image that provides some basic dependencies, then installs additional software and dependencies as necessary. It may also provide metadata, set up scripts, and define commands to run when the container starts.</p>
<p>For a base image, we’ll start with <a href="https://github.com/conda-forge/miniforge-images">condaforge/mambaforge</a> which is maintained by condaforge and provides conda on top of ubuntu-20.04. Replace the contents of the <code>docker/Dockerfile</code> file with the following to install <a href="https://anaconda.org/bioconda/samtools">SAMtools via bioconda</a>.</p>
<pre><code>FROM condaforge/mambaforge

RUN conda config \
    --add channels defaults \
    --add channels bioconda \
    --add channels conda-forge

RUN conda install -y samtools</code></pre>
<p>Run the GitHub Action by navigating to the Actions tab, selecting Docker management, and clicking on Run workflow. Note that you must change <code>Push to Dockerhub?</code> to true.</p>
<p><img src="05-customize-docker_files/figure-html/1o2XnuMbqWVLf4XrsXolIQ7ulfnMlpJlrUxN0Y8aLIVQ_g158d610a26d_0_20.png" width="100%" /></p>
<div class="warning">
<p>You <strong>must</strong> change <code>Push to Dockerhub?</code> to true for your Docker image to be pushed to Docker Hub.</p>
</div>
</div>
<div id="use-your-image-with-the-idxstats-wdl" class="section level2" number="5.6">
<h2><span class="header-section-number">5.6</span> Use your image with the idxstats WDL</h2>
<p>The next step is to modify the WDL script that you wrote in Chapter 4 to run in a container built by this Docker image. Edit your idxstats WDL script to call <code>samtools idxstats</code> on a bam file to specify your customized Docker image.</p>
<p>The result should look something like the version below, except that your version should point to the name of your own Docker image’s repository, rather than <code>cutsort/test</code>:</p>
<pre><code>version 1.0
workflow samtoolsIdxstats {
  input {
    File bamfile
  }
  call idxstats {
    input: 
      bamfile = bamfile
  }
  output {
    File results = idxstats.idxstats
  }
}

task idxstats {
  input {
    File bamfile
  }
  command &lt;&lt;&lt;
    samtools index ~{bamfile}
    samtools idxstats ~{bamfile} &gt; idxstats.txt
  &gt;&gt;&gt;
  output {
    File idxstats = &quot;idxstats.txt&quot;
  }
  runtime {
    docker: &#39;cutsort/test&#39;
  }
}</code></pre>
<p>The next step is to add this WDL script to the Broad Methods Repository in order to run the workflow in Terra.</p>
<p>Follow the steps outlined in Chapter 3 to access the Broad Methods Repository and create a new method.</p>
<p>Then, copy or upload your WDL script into the new method and export it to your cloned version of the WDL-puzzles workspace.</p>
</div>
<div id="run-idxstats-workflow" class="section level2" number="5.7">
<h2><span class="header-section-number">5.7</span> Run idxstats workflow</h2>
<p>Once you’ve exported the workflow to your AnVIL-powered-by-Terra workspace, open the workflow.</p>
<p>Select “Run workflow(s) with inputs defined by data table”, select the “bam” table, and select one row of the data table for a test run.</p>
<p><img src="05-customize-docker_files/figure-html/1o2XnuMbqWVLf4XrsXolIQ7ulfnMlpJlrUxN0Y8aLIVQ_g158d610a26d_0_26.png" width="100%" /></p>
<p>Fill in the column that stores the path to the input bam file (this.file_path).</p>
<p>In the Outputs tab, give the output column a name by typing this.COLUMN_NAME (for example, this.idxstats_output).</p>
<p>Then click “run” to run the workflow, and monitor its progress. Once the workflow has finished running, you should see a new column in the “bam” table with a link to a .txt file with the QC metrics output by the workflow.</p>
</div>
<div id="best-practices-for-using-docker" class="section level2" number="5.8">
<h2><span class="header-section-number">5.8</span> Best practices for using Docker</h2>
<p>The WDL Analysis Research Pipelines (WARP) <a href="https://github.com/broadinstitute/warp-tools/blob/develop/README.md">GitHub page</a> lists some recommendations for setting up Docker containers. Here are a few highlights:</p>
<ul>
<li><strong>Make sure that your image isn’t too large</strong>, to avoid using unnecessary compute resources. Start with small images (e.g., Alpine) and include as few run steps as possible in the image file.</li>
<li>Make dockers <strong>publicly accessible</strong>.</li>
</ul>
</div>
<div id="further-reading-1" class="section level2" number="5.9">
<h2><span class="header-section-number">5.9</span> Further Reading</h2>
<p>If you’re interested in a deeper dive into this chapter’s topics, check out these optional articles:</p>
<ul>
<li>To learn more about how to use Docker to create and store images, read <a href="https://support.terra.bio/hc/en-us/articles/360037340472-Docker-container-overview">Docker/container overview</a>.</li>
<li>For information on using Docker to develop images locally, read <a href="https://support.terra.bio/hc/en-us/articles/360036000631-How-to-install-Docker-and-test-that-it-works">how to install docker and test that it works</a>.</li>
<li><a href="https://support.terra.bio/hc/en-us/articles/360036007791-How-to-run-GATK-in-a-Docker-container">How to run GATK in a Docker container</a></li>
<li><a href="https://support.terra.bio/hc/en-us/articles/4409141003547-Docker-Image-Publishers-Tips">Docker Image Publishers’ Tips</a></li>
</ul>

</div>
</div>
<hr>
<center> 
  <div class="footer">
      All illustrations <a href="https://creativecommons.org/licenses/by/4.0/">CC-BY. </a>
      <br>
      All other materials <a href= "https://creativecommons.org/licenses/by/4.0/"> CC-BY </a> unless noted otherwise.
  </div>
</center>
            </section>

          </div>
        </div>
      </div>
<a href="calculate-idxstats-on-multiple-files.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="join-discourse.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "section"
}
});
});
</script>

</body>

</html>
